generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  Admin
  TeamLead
  Technician
  Viewer
}

enum AuthProvider {
  local
  ldap
}

enum TaskStatus {
  Open
  InProgress
  PendingVendor
  PendingUser
  Resolved
  Closed
}

enum TaskPriority {
  Low
  Medium
  High
  Critical
}

enum NotificationType {
  TaskAssigned
  TaskStatusChanged
  TaskClosed
  AddedAsSubscriber
  CommentAdded
}

model Team {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  members     User[]
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  role         Role
  passwordHash String
  authProvider AuthProvider @default(local)
  isBootstrapAdmin Boolean @default(false)
  teamId       String?
  // Account security fields
  failedLoginAttempts Int @default(0)
  isLocked Boolean @default(false)
  lockedAt DateTime?
  lastFailedLoginAt DateTime?
  createdAt    DateTime  @default(now())
  team         Team?     @relation(fields: [teamId], references: [id], onDelete: SetNull)
  tasksCreated Task[]    @relation("TasksCreated")
  tasksAssigned Task[]   @relation("TasksAssigned")
  subscribedTasks Task[] @relation("TaskSubscribers")
  recurringTemplates RecurringTaskConfig[] @relation("TemplateAssignee")
  recurringTasksCreated RecurringTaskConfig[] @relation("RecurringTaskCreator")
  comments     Comment[]
  attachments  Attachment[]
  auditLogs    AuditLog[]
  systemLogs   SystemLog[]
  mentions     Mention[] @relation("UserMentions")
  sessions     Session[]
  notificationsSent     Notification[] @relation("NotificationActor")
  notificationsReceived Notification[] @relation("NotificationRecipient")

  @@index([teamId])
}

model Task {
  id             String            @id @default(uuid())
  title          String
  description    String
  dueDate        DateTime?
  slaDeadline    DateTime?
  status         TaskStatus        @default(Open)
  priority       TaskPriority      @default(Medium)
  branch         String?
  type           TaskType          @default(Standard)
  tags           String[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  creatorId      String
  assigneeId     String
  recurringConfigId String?
  parentTaskId   String?
  creator        User              @relation("TasksCreated", fields: [creatorId], references: [id])
  assignee       User              @relation("TasksAssigned", fields: [assigneeId], references: [id])
  parentTask     Task?             @relation("SubTasks", fields: [parentTaskId], references: [id])
  subTasks       Task[]            @relation("SubTasks")
  context        TaskContext?
  recurringConfig RecurringTaskConfig? @relation(fields: [recurringConfigId], references: [id])
  comments       Comment[]
  attachments    Attachment[]
  auditLogs      AuditLog[]
  systemLogs     SystemLog[]
  subscribers    User[]            @relation("TaskSubscribers")
  notifications  Notification[]

  @@index([assigneeId])
  @@index([creatorId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([slaDeadline])
  @@index([updatedAt])
  @@index([status, priority])
  @@index([assigneeId, status])
}

enum TaskType {
  Standard
  Recurring_Instance
}

model TaskContext {
  id             String   @id @default(uuid())
  taskId         String   @unique
  serverName     String?
  application    String?
  workstationId  String?
  adUser         String?
  environment    String?
  ipAddress      String?
  manufacturer   String?
  version        String?
  task           Task     @relation(fields: [taskId], references: [id])
}

model RecurringTaskConfig {
  id              String    @id @default(uuid())
  name            String
  cron            String
  lastGeneratedAt DateTime?
  nextGenerationAt DateTime?
  templateTitle   String
  templateDescription String?
  templatePriority TaskPriority @default(Medium)
  templateAssigneeId String
  creatorId       String?
  templateBranch  String?
  templateServerName String?
  templateApplication String?
  templateIpAddress String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  tasks           Task[]
  templateAssignee User      @relation("TemplateAssignee", fields: [templateAssigneeId], references: [id])
  creator         User?      @relation("RecurringTaskCreator", fields: [creatorId], references: [id])

  @@index([nextGenerationAt])
}

model Comment {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  mentions  Mention[]

  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
  @@index([taskId, createdAt])
}

model Mention {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation("UserMentions", fields: [userId], references: [id])
}

model Attachment {
  id         String   @id @default(uuid())
  taskId     String
  uploadedBy String
  filePath   String
  fileType   String
  createdAt  DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id])
  user       User     @relation(fields: [uploadedBy], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  taskId    String
  actorId   String
  action    String
  oldValue  Json?
  newValue  Json?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  actor     User     @relation(fields: [actorId], references: [id])

  @@index([taskId])
  @@index([actorId])
  @@index([createdAt])
  @@index([taskId, createdAt])
}

enum LogEntityType {
  Task
  Comment
  Attachment
  RecurringTask
  User
  Team
  System
}

enum LogActionType {
  Create
  Update
  Delete
  Assign
  StatusChange
  PriorityChange
  Comment
  Attachment
  Generate
  Login
  Logout
  PermissionChange
}

model SystemLog {
  id          String         @id @default(uuid())
  entityType  LogEntityType
  actionType  LogActionType
  actorId     String
  entityId    String?
  taskId      String?
  taskTitle   String?
  description String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime       @default(now())
  actor       User           @relation(fields: [actorId], references: [id])
  task        Task?          @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([entityType])
  @@index([actionType])
  @@index([actorId])
  @@index([taskId])
  @@index([entityId])
  @@index([createdAt])
  @@index([entityType, actionType])
  @@index([createdAt, entityType])
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model SystemConfig {
  id        String   @id @default("system")
  
  // SMTP Configuration
  smtpHost  String?  @default("localhost")
  smtpPort  Int?     @default(25)
  smtpFrom  String?  @default("no-reply@local")
  smtpSecure Boolean @default(false)
  smtpUser  String?
  smtpPassword String? // Encrypted in production
  
  // SLA Defaults (in hours)
  slaLowHours      Int? @default(120)  // 5 days
  slaMediumHours   Int? @default(48)   // 2 days
  slaHighHours     Int? @default(24)   // 1 day
  slaCriticalHours Int? @default(4)    // 4 hours
  
  // LDAP Configuration
  ldapEnabled      Boolean @default(false)
  ldapHost         String?
  ldapPort         Int?    @default(389)
  ldapBaseDn       String?
  ldapBindDn       String?
  ldapBindPassword String? // Encrypted in production
  ldapUseTls       Boolean @default(false)
  ldapUserSearchFilter String? @default("(uid={{username}})")
  ldapUsernameAttribute String? @default("uid")
  ldapEnforced     Boolean @default(false) // If true, only LDAP auth (except bootstrap admin)
  
  // Variable Configuration
  supportEmail     String?

  // Branding & Reports
  orgLogo          String?
  reportFooterText String?

  // Localization & Time
  timezone         String? @default("UTC")
  dateFormat       String? @default("DD/MM/YYYY")
  timeFormat       String? @default("24h")

  // Collaboration & Content
  enableAttachments      Boolean @default(true)
  maxAttachmentSizeMb    Int?    @default(10)
  enableComments         Boolean @default(true)
  enableMentions         Boolean @default(true)

  // Security & Authentication
  sessionTimeoutHours        Int? @default(24)
  maxFailedLoginAttempts     Int? @default(5)
  lockUserAfterFailedLogins  Boolean @default(true)
  passwordPolicyLevel        String? @default("strong")

  // Audit & Retention
  auditRetentionDays Int? @default(365)

  updatedAt DateTime @updatedAt
  updatedBy String?
}

model Notification {
  id        String            @id @default(uuid())
  userId    String
  actorId   String?
  taskId    String
  type      NotificationType
  title     String
  content   String?
  isRead    Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user      User              @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  actor     User?             @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)
  task      Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([taskId])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([userId, createdAt])
}

